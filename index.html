<!DOCTYPE html>
<html>
<head>
  <title>FarmLabs All-in-One: Counter Bot & Deployer</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Using Ethers.js v5.7.2 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #0f0;
      padding: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    h2 {
      color: #0f0;
      margin-bottom: 20px;
      text-align: center;
    }
    .container {
      width: 100%;
      max-width: 650px; /* Slightly wider container for tabs */
      background: #222;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #0f0;
    }
    .tab-button {
      flex: 1;
      padding: 10px 15px;
      background: #333;
      color: #0f0;
      border: none;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .tab-button.active {
      background: #0f0;
      color: #000;
    }
    .tab-button:hover:not(.active) {
      background: #444;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    div.input-group { /* Specific class for input groups */
      width: 100%;
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #0f0;
    }
    input[type="text"],
    input[type="number"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      background: #1a1a1a;
      color: #0f0;
      border: 1px solid #0f0; /* Green border for inputs */
      padding: 10px;
      box-sizing: border-box;
      border-radius: 5px;
      font-size: 1em;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    button {
      padding: 12px 20px;
      margin-top: 10px;
      font-weight: bold;
      cursor: pointer;
      background: #0f0;
      color: #000;
      border: none;
      border-radius: 8px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 255, 0, 0.2);
      width: 100%;
    }
    button:hover {
      background-color: #00cc00;
      box-shadow: 0 6px 8px rgba(0, 255, 0, 0.3);
    }
    button:disabled {
      background: #444;
      color: #888;
      cursor: not-allowed;
      box-shadow: none;
    }
    #log {
      margin-top: 20px;
      white-space: pre-wrap;
      background: #000;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      width: 100%;
      border: 1px solid #0f0;
      border-radius: 8px;
      line-height: 1.4;
      font-size: 0.9em;
    }
    .log-success { color: #00ff00; }
    .log-error { color: #ff0000; }
    .log-info { color: #00ffff; }
    .log-warning { color: #ffff00; }
  </style>
</head>
<body>

  <h2>‚öôÔ∏è FarmLabs: All-in-One Bot & Deployer</h2>

  <div class="container">
    <div class="tabs">
      <button class="tab-button active" onclick="openTab('bot-tab')">Counter Bot</button>
      <button class="tab-button" onclick="openTab('deployer-tab')">Contract Deployer</button>
    </div>

    <div id="bot-tab" class="tab-content active">
      <h3>Counter Farming Bot (Pro Edition)</h3>

      <div class="input-group">
        <label for="bot-rpc">üîó Base RPC URL</label>
        <input id="bot-rpc" type="text" value="https://base.llamarpc.com" />
      </div>

      <div class="input-group">
        <label for="bot-contract">üì¶ Counter Contract Address</label>
        <input id="bot-contract" type="text" placeholder="0xYourDeployedCounterAddress" />
      </div>

      <div class="input-group">
        <label for="bot-keys">üîê Private Keys (one per line)</label>
        <textarea id="bot-keys" rows="5" placeholder="0xabc123...\n0xdef456..."></textarea>
      </div>

      <div class="input-group">
        <label for="bot-maxRetries">üîÑ Max Retries on Fail</label>
        <input type="number" id="bot-maxRetries" value="1" min="0" />
      </div>

      <div class="input-group">
        <label for="bot-retryDelay">‚è≥ Retry Delay (ms)</label>
        <input type="number" id="bot-retryDelay" value="5000" min="500" />
      </div>

      <div class="input-group">
        <label for="bot-mode">üéØ Action Type</label>
        <select id="bot-mode">
          <option value="random">Random (inc/dec)</option>
          <option value="increment">Force Increment</option>
          <option value="decrement">Force Decrement</option>
        </select>
      </div>

      <div class="input-group">
        <label for="bot-repeat">üîÅ Repeat Mode</label>
        <select id="bot-repeat">
          <option value="no">Run Once</option>
          <option value="yes">Loop Forever</option>
        </select>
      </div>

      <button id="bot-startButton" onclick="startFarmingBot()">üöÄ Start Bot</button>
      <button id="bot-stopButton" onclick="stopFarmingBot()" disabled>‚èπÔ∏è Stop Bot</button>
    </div>

    <div id="deployer-tab" class="tab-content">
      <h3>Deploy Counter Contract</h3>

      <div class="input-group">
        <label for="deployer-pk">üîê Private Key (never leaves browser)</label>
        <input type="password" id="deployer-pk" placeholder="0x...">
      </div>

      <div class="input-group">
        <label for="deployer-rpc">üåê Base RPC URL</label>
        <input id="deployer-rpc" value="https://mainnet.base.org">
      </div>

      <div class="input-group">
        <label for="deployer-apikey">üß™ BaseScan API Key (for manual verification info)</label>
        <input id="deployer-apikey" placeholder="paste your BaseScan key here">
      </div>

      <button id="deployButton" onclick="startDeployer()">üöÄ Deploy Counter Contract</button>
    </div>

    <pre id="log">Logs:\n</pre>
  </div>

  <script>
    // --- Global Contract Data ---
    const counterABI = [
      { "inputs": [], "name": "count", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
      { "inputs": [], "name": "decrement", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
      { "inputs": [], "name": "increment", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
    ];

    // Hardcoded Contract Bytecode (from compiling Counter.sol with solidity ^0.8.0, e.g., 0.8.20)
    const counterBytecode = "0x608060405234801561001057600080fd5b5060ae8061001f6000396000f3fe6080604052348015600f575f80fd5b506004361060395760003560e01c80630c7275ed14603e5780632a129cf414605657806377160249146074575b5f80fd5b6044600480360381019080803590602001909291905050506086565b6040518082815260200191505060405180910390f35b6060600480360381019080803590602001909291905050506093565b60626004803603810190808035906020019092919050505060aa565b5f8054905090565b5f8054600101905090565b5f805460019081815260209020900160009081526020600020900101905060ad565b82805460018160011614905550505056fea2646970667358221220a28383e601249b674b88950d9841f3d8f9c065842813583c276f598462ef5e5464736f6c63430008140033";

    // --- Global Utility Functions ---
    const log = (msg, type = 'info') => {
      const logEl = document.getElementById("log");
      const span = document.createElement('span');
      span.className = `log-${type}`;
      span.textContent = msg;
      logEl.appendChild(span);
      logEl.textContent += "\n";
      logEl.scrollTop = logEl.scrollHeight;
    };

    const sleep = ms => new Promise(res => setTimeout(res, ms));
    const randomDelay = (min = 5000, max = 15000) => Math.floor(Math.random() * (max - min + 1)) + min;

    // Helper to run a function with retries
    async function runWithRetry(fn, retries = 1, delay = 5000) {
      for (let i = 0; i <= retries; i++) {
        try {
          return await fn();
        } catch (err) {
          log(`‚ö†Ô∏è Attempt ${i + 1} failed: ${err.message}`, 'warning');
          if (i < retries) {
            log(`üîÅ Retrying in ${delay / 1000}s...`, 'info');
            await sleep(delay);
          } else {
            throw new Error(`All ${retries + 1} attempts failed: ${err.message}`);
          }
        }
      }
    }

    // --- Tab Switching Logic ---
    function openTab(tabId) {
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => content.classList.remove('active'));

      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => button.classList.remove('active'));

      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active'); // Set clicked button as active
      document.getElementById("log").textContent = 'Logs:\n'; // Clear log on tab switch
    }

    // --- Counter Bot Logic ---
    let isFarmingBotRunning = false;
    let farmingBotStopFlag = false;

    function updateFarmingBotButtonStates(running) {
      document.getElementById("bot-startButton").disabled = running;
      document.getElementById("bot-stopButton").disabled = !running;
      document.getElementById("bot-rpc").disabled = running;
      document.getElementById("bot-contract").disabled = running;
      document.getElementById("bot-keys").disabled = running;
      document.getElementById("bot-maxRetries").disabled = running;
      document.getElementById("bot-retryDelay").disabled = running;
      document.getElementById("bot-mode").disabled = running;
      document.getElementById("bot-repeat").disabled = running;
    }

    function stopFarmingBot() {
      farmingBotStopFlag = true;
      log("üõë Stop command received. Finishing current wallet and then stopping farming bot...", 'info');
    }

    async function processFarmingWallet(wallet, contract, action, index, maxRetries, retryDelayMs) {
      const address = wallet.address;
      let gasUsed = ethers.BigNumber.from(0);

      try {
        const countBefore = await runWithRetry(() => contract.count(), maxRetries, retryDelayMs);
        log(`üîç Wallet ${index + 1} (${address.slice(0, 6)}...${address.slice(-4)}):\n   Current Count: ${countBefore.toString()}`);

        const estimatedGas = await runWithRetry(() => contract.estimateGas[action](), maxRetries, retryDelayMs);
        log(`‚õΩ Gas estimate for ${action}: ${estimatedGas.toString()} units`);

        if (Math.random() < 0.1) { // 10% chance for dummy read
            await runWithRetry(() => contract.count(), maxRetries, retryDelayMs);
            log(`üëÄ Performed dummy view call: count()`);
        }

        const tx = await runWithRetry(() => contract[action](), maxRetries, retryDelayMs);
        log(`üöÄ TX Sent (${action}): ${tx.hash}`);

        const receipt = await runWithRetry(() => tx.wait(), maxRetries, retryDelayMs);
        gasUsed = receipt.gasUsed;

        const countAfter = await runWithRetry(() => contract.count(), maxRetries, retryDelayMs);
        log(`‚úÖ Confirmed. Updated Count: ${countAfter.toString()} | Gas Used for this TX: ${gasUsed.toString()} units`, 'success');

      } catch (err) {
        log(`‚ùå Wallet ${index + 1} (${address.slice(0, 6)}...${address.slice(-4)}) error: ${err.message}`, 'error');
      }

      return gasUsed;
    }

    async function startFarmingBot() {
      if (isFarmingBotRunning) {
        log("Farming bot is already running. Please stop it first.", 'warning');
        return;
      }

      const rpc = document.getElementById("bot-rpc").value.trim();
      const contractAddress = document.getElementById("bot-contract").value.trim();
      const keys = document.getElementById("bot-keys").value.trim().split("\n").filter(k => k);
      const maxRetries = parseInt(document.getElementById("bot-maxRetries").value) || 1;
      const retryDelayMs = parseInt(document.getElementById("bot-retryDelay").value) || 5000;
      const actionMode = document.getElementById("bot-mode").value;
      const repeatMode = document.getElementById("bot-repeat").value === "yes";

      document.getElementById("log").textContent = 'Logs:\n'; // Clear logs for new session

      if (!rpc || !ethers.utils.isAddress(contractAddress) || keys.length === 0) {
        return log("‚ùå Please ensure RPC URL, a valid Contract Address, and Private Keys are provided for the bot.", 'error');
      }

      isFarmingBotRunning = true;
      farmingBotStopFlag = false;
      updateFarmingBotButtonStates(true);

      log("üöÄ Starting farming bot interaction...", 'info');
      log(`Configured with ${keys.length} wallets, Max Retries: ${maxRetries}, Retry Delay: ${retryDelayMs / 1000}s`);
      log(`Action Type: ${actionMode.charAt(0).toUpperCase() + actionMode.slice(1)} | Repeat Mode: ${repeatMode ? 'Loop Forever' : 'Run Once'}`, 'info');

      const provider = new ethers.providers.JsonRpcProvider(rpc);
      const wallets = [];
      for (const pk of keys) {
        try {
          wallets.push(new ethers.Wallet(pk.trim(), provider));
        } catch (e) {
          log(`‚ùå Invalid private key encountered: ${pk.slice(0, 10)}... Skipping this key.`, 'error');
        }
      }

      if (wallets.length === 0) {
        log("‚ùå No valid wallets loaded for farming. Please check your private keys.", 'error');
        isFarmingBotRunning = false;
        updateFarmingBotButtonStates(false);
        return;
      }

      do {
        let totalGasForCycle = ethers.BigNumber.from(0);

        for (let i = 0; i < wallets.length; i++) {
          if (farmingBotStopFlag) break;

          const wallet = wallets[i];
          const contract = new ethers.Contract(contractAddress, counterABI, wallet);
          
          let action;
          if (actionMode === "random") {
            action = Math.random() > 0.5 ? "increment" : "decrement";
          } else {
            action = actionMode;
          }

          const gasUsedByWallet = await processFarmingWallet(wallet, contract, action, i, maxRetries, retryDelayMs);
          totalGasForCycle = totalGasForCycle.add(gasUsedByWallet);

          if (farmingBotStopFlag) break;

          const delay = randomDelay();
          log(`‚è±Ô∏è Waiting ${delay / 1000}s before next wallet...`, 'info');
          await sleep(delay);
        }

        log(`üìä Cycle Complete. Total Gas Used for this cycle: ${totalGasForCycle.toString()} units\n`, 'info');

      } while (repeatMode && !farmingBotStopFlag);

      isFarmingBotRunning = false;
      farmingBotStopFlag = false;
      updateFarmingBotButtonStates(false);
      log("\nüéâ All farming operations completed. Bot finished.", 'success');
    }

    // --- Contract Deployer Logic ---
    let isDeploying = false;

    function updateDeployerButtonStates(deploying) {
        document.getElementById("deployButton").disabled = deploying;
        document.getElementById("deployer-pk").disabled = deploying;
        document.getElementById("deployer-rpc").disabled = deploying;
        document.getElementById("deployer-apikey").disabled = deploying;
    }

    async function startDeployer() {
      if (isDeploying) {
        log("Deployment already in progress. Please wait...", 'warning');
        return;
      }

      let privateKey = document.getElementById("deployer-pk").value.trim();
      const rpcUrl = document.getElementById("deployer-rpc").value.trim();
      const apiKey = document.getElementById("deployer-apikey").value.trim();

      document.getElementById("log").textContent = 'Logs:\n'; // Clear logs for new session

      if (!privateKey || !rpcUrl) {
        return log("‚ùå Please fill in Private Key and Base RPC URL for deployment.", 'error');
      }
      
      if (!privateKey.startsWith('0x') && privateKey.length === 64) {
        log("Adding '0x' prefix to private key.", 'info');
        privateKey = '0x' + privateKey;
      } else if (!privateKey.startsWith('0x')) {
        return log("‚ùå Private Key must start with '0x' or be 64 characters long.", 'error');
      }
      
      if (privateKey.length !== 66) {
          return log("‚ùå Private Key must be 66 characters long (including '0x').", 'error');
      }

      isDeploying = true;
      updateDeployerButtonStates(true);
      log("üöÄ Initiating contract deployment...", 'info');

      try {
        const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
        const wallet = new ethers.Wallet(privateKey, provider);

        log(`Connected to RPC: ${rpcUrl}`, 'info');
        log(`Deployer address: ${wallet.address}`, 'info');

        const balance = await wallet.getBalance();
        log(`Wallet balance: ${ethers.utils.formatEther(balance)} ETH`, 'info');
        if (balance.isZero()) {
          log("‚ùå Wallet has 0 ETH. Please fund your wallet before deploying.", 'error');
          return; // Exit without finally block
        }

        const factory = new ethers.ContractFactory(counterABI, counterBytecode, wallet);

        log("üì¶ Sending deployment transaction...", 'info');
        const contract = await factory.deploy();
        log(`‚û°Ô∏è Deployment TX Hash: ${contract.deployTransaction.hash}`, 'info');

        log("‚è≥ Waiting for transaction to be mined...", 'info');
        await contract.deployed();
        log(`‚úÖ Contract deployed at: ${contract.address}`, 'success');

        log(`\n--- Manual Verification Steps ---`, 'info');
        log(`To verify your contract on BaseScan, visit:`, 'info');
        log(`https://basescan.org/address/${contract.address}#code`, 'info');
        log(`\nSelect 'Solidity (Single File)' or 'Solidity (Standard-Json)'.`, 'info');
        log(`Set Compiler Version to 'v0.8.20+commit.a1b79de6' (or specific version used to get bytecode).`, 'info');
        log(`Optimization: 'No' (if not optimized, or 'Yes' with runs: 200).`, 'info');
        log(`Paste the exact 'Counter.sol' source code into the text area.`, 'info');
        log(`\nIf you have a BaseScan API Key (${apiKey ? 'Provided' : 'NOT Provided'}), you could use a backend service or curl to verify programmatically.`, 'info');

      } catch (err) {
        log(`‚ùå Deployment failed: ${err.message}`, 'error');
        console.error(err);
      } finally {
        isDeploying = false;
        updateDeployerButtonStates(false);
        document.getElementById("deployer-pk").value = ''; // Clear private key input for security
      }
    }
  </script>

</body>
</html>
