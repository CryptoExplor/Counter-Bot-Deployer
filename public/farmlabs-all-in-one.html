<!DOCTYPE html>
<html>
<head>
  <title>FarmLabs All-in-One: Counter Bot & Deployer</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Using Ethers.js v5.7.2 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- QRCode.js for QR Code generation -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Google Fonts: Fira Code for monospace and Inter for general text -->
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif; /* Primary font for body */
      background: #0b0f10; /* Darker background */
      color: #00ff90; /* Neon green primary color */
      padding: 30px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      min-height: 100vh;
    }

    h2 {
      font-family: 'Fira Code', monospace; /* Fira Code for headings */
      color: #00ff90;
      font-size: 1.8rem;
      margin-bottom: 30px;
      text-align: center;
      text-shadow: 0 0 5px #00ff90; /* Neon glow effect */
    }

    h3 {
      font-family: 'Fira Code', monospace;
      color: #00ffaa;
      font-size: 1.4rem;
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 0 0 3px #00ffaa;
    }

    .container {
      width: 100%;
      max-width: 700px; /* Wider container for grid layout */
      background: #151d1f; /* Dark background for container */
      border: 1px solid #00ff9099; /* Neon green border */
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 0 20px rgba(0, 255, 144, 0.4); /* Stronger neon glow */
      margin-bottom: 25px; /* Space before footer */
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #00ff90;
    }
    .tab-button {
      flex: 1;
      padding: 12px 15px;
      background: #252d2f; /* Slightly lighter tab background */
      color: #00ff90;
      border: none;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
      font-family: 'Fira Code', monospace;
      text-shadow: 0 0 2px #00ff90;
    }
    .tab-button.active {
      background: #00ff90;
      color: #000;
      box-shadow: 0 -2px 8px rgba(0, 255, 144, 0.6);
      transform: translateY(-2px);
    }
    .tab-button:hover:not(.active) {
      background: #353d3f;
      color: #00ffcc;
    }
    .tab-content {
      display: none;
      padding-top: 15px;
    }
    .tab-content.active {
      display: block;
    }

    /* Grid Layout for inputs */
    .grid {
      display: grid;
      gap: 18px; /* Increased gap */
      grid-template-columns: 1fr; /* Default to single column for mobile */
    }

    @media (min-width: 600px) { /* Adjust breakpoint for two columns */
      .grid {
        grid-template-columns: 1fr 1fr;
      }
      /* Make specific elements span full width in grid */
      .grid .span-2 {
        grid-column: span 2;
      }
    }

    label {
      margin-bottom: 5px;
      display: block;
      font-size: 0.95em;
      color: #00ffaa; /* Brighter neon green for labels */
    }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      background: #0a0f0f; /* Even darker input background */
      border: 1px solid #00ff9099;
      color: #00ff90;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.95em;
      box-shadow: inset 0 0 5px rgba(0, 255, 144, 0.2); /* Subtle inner glow */
      transition: border 0.3s ease, box-shadow 0.3s ease;
      font-family: 'Fira Code', monospace; /* Fira Code for inputs */
    }

    input:focus, textarea:focus, select:focus {
      border: 1px solid #00ffcc;
      outline: none;
      box-shadow: inset 0 0 8px rgba(0, 255, 204, 0.5), 0 0 5px rgba(0, 255, 204, 0.7); /* Stronger focus glow */
    }

    button {
      background: linear-gradient(145deg, #00ff90, #00ffaa); /* Gradient for buttons */
      color: #000;
      font-weight: bold;
      padding: 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 10px rgba(0, 255, 144, 0.6);
      font-family: 'Inter', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    button:hover {
      box-shadow: 0 6px 15px rgba(0, 255, 204, 0.8);
      transform: translateY(-2px);
    }

    button:disabled {
      background: #444;
      color: #888;
      cursor: not-allowed;
      box-shadow: none;
      transform: translateY(0);
    }

    #log {
      background: #0a0f0f; /* Dark background for log */
      padding: 15px;
      border: 1px solid #00ff90;
      border-radius: 8px;
      margin-top: 30px;
      height: 300px;
      overflow-y: auto;
      width: 100%;
      max-width: 700px;
      white-space: pre-wrap;
      font-family: 'Fira Code', monospace; /* Fira Code for logs */
      font-size: 0.9em;
      line-height: 1.4;
      box-shadow: inset 0 0 8px rgba(0, 255, 144, 0.2);
    }

    .log-success { color: #00ff00; }
    .log-error { color: #ff5555; }
    .log-info { color: #00ddff; }
    .log-warning { color: #ffff66; }

    /* --- Footer Styles --- */
    .footer {
        background-color: #0a0a0a; /* Darker black for footer */
        color: #00ff90; /* Green text */
        padding: 40px 20px;
        text-align: center;
        width: 100%; /* Full width */
        max-width: 700px; /* Match container width */
        border-radius: 10px;
        box-sizing: border-box;
        margin-top: 25px; /* Space above footer */
        border: 1px solid #00ff9099;
        box-shadow: 0 0 15px rgba(0, 255, 144, 0.3);
    }
    .footer h3 {
        font-family: 'Fira Code', monospace;
        font-size: 1.8em;
        font-weight: bold;
        margin-bottom: 10px;
        color: #00ff90; /* Brighter green for heading */
        text-shadow: 0 0 5px #00ff90;
    }
    .footer p {
        font-family: 'Inter', sans-serif;
        font-size: 0.9em;
        margin-bottom: 20px;
        color: #00cc00; /* Slightly darker green for paragraph */
    }
    .donation-box {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #1a1a1a; /* Darker background for address box */
        padding: 10px;
        border-radius: 8px;
        max-width: 400px;
        margin: 0 auto 25px auto;
        border: 1px solid #00ff90; /* Green border */
        box-shadow: inset 0 0 5px rgba(0, 255, 144, 0.2);
    }
    .donation-address-text {
        font-size: 0.85em;
        font-family: 'Fira Code', monospace;
        word-break: break-all;
        margin-right: 10px;
        color: #00ddff; /* Cyan for address */
    }
    .footer-icon-button {
        background: none;
        border: none;
        color: #00ff90; /* Green for icons */
        cursor: pointer;
        padding: 8px;
        border-radius: 5px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    .footer-icon-button:hover {
        background-color: #333;
        color: #00ddff; /* Cyan on hover */
    }
    .footer-social-links {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 25px;
        gap: 20px;
    }
    .footer-social-links a {
        color: #00ff90;
        font-size: 1.5em;
        transition: color 0.3s ease;
    }
    .footer-social-links a:hover {
        color: #00ddff; /* Cyan on hover */
    }
    .footer-copyright {
        font-size: 0.8em;
        color: #00cc00;
        margin-top: 20px;
    }

    /* --- Modal Styles --- */
    .modal {
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8); /* Darker overlay */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background-color: #151d1f; /* Dark background */
        margin: auto;
        padding: 25px;
        border: 1px solid #00ff90; /* Green border */
        width: 90%;
        max-width: 450px; /* Slightly larger modal */
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,255,144,0.6); /* Green glow */
        position: relative;
        text-align: center;
        color: #00ff90;
    }
    .close-qr-button {
        color: #00ff90;
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s ease;
    }
    .close-qr-button:hover,
    .close-qr-button:focus {
        color: #00ddff; /* Cyan on hover */
    }
    #qr-code-container {
        padding: 10px;
        background-color: #ffffff; /* QR code itself needs white background */
        display: inline-block;
        border-radius: 5px;
        margin-top: 15px;
        box-shadow: 0 0 10px rgba(0, 255, 144, 0.3);
    }
    #qr-address-display {
        font-family: 'Fira Code', monospace;
        font-size: 0.85em;
        margin-top: 15px;
        word-break: break-all;
        color: #00ddff; /* Cyan for address */
    }
    .hidden {
        display: none !important;
    }

    /* Style for live gas display */
    .gas-display {
      font-size: 0.85em;
      color: #00ddff; /* Cyan color for info */
      margin-top: 5px;
      display: block; /* Ensure it takes its own line */
    }
  </style>
</head>
<body>

  <h2>‚öôÔ∏è FarmLabs: All-in-One Bot & Deployer</h2>

  <div class="container">
    <div class="tabs">
      <button class="tab-button active" onclick="openTab('bot-tab')">Counter Bot</button>
      <button class="tab-button" onclick="openTab('deployer-tab')">Contract Deployer</button>
    </div>

    <div id="bot-tab" class="tab-content active">
      <h3>Counter Farming Bot (Pro Edition)</h3>

      <div class="grid">
        <div class="input-group">
          <label for="bot-chain">üîó Select Chain</label>
          <select id="bot-chain" onchange="updateRpcDropdown('bot')">
            <option value="base">Base Mainnet</option>
            <option value="linea">Linea Mainnet</option>
            <option value="scroll">Scroll Mainnet</option>
            <option value="sepolia">Sepolia Testnet</option>
          </select>
        </div>

        <div class="input-group">
          <label for="bot-rpc-select">üåê Select RPC URL</label>
          <select id="bot-rpc-select"></select>
        </div>
        <!-- Hidden input to store the selected RPC URL -->
        <input type="hidden" id="bot-rpc" />

        <div class="input-group span-2">
          <label for="bot-contract">üì¶ Counter Contract Address</label>
          <input id="bot-contract" type="text" placeholder="0xYourDeployedCounterAddress" />
        </div>

        <div class="input-group span-2">
          <label for="bot-keys">üîê Private Keys (one per line, optional #nickname)</label>
          <textarea id="bot-keys" rows="5" placeholder="0xabc123...\n0xdef456...#myWallet"></textarea>
        </div>

        <div class="input-group">
          <label for="bot-maxRetries">üîÑ Max Retries on Fail</label>
          <input type="number" id="bot-maxRetries" value="1" min="0" />
        </div>

        <div class="input-group">
          <label for="bot-retryDelay">‚è≥ Retry Delay (ms)</label>
          <input type="number" id="bot-retryDelay" value="5000" min="500" />
        </div>

        <div class="input-group">
          <label for="bot-maxGasPriceGwei">‚õΩ Max Gas Price (Gwei, 0 for no limit)</label>
          <input type="number" id="bot-maxGasPriceGwei" value="1" min="0" />
        </div>
        <div class="input-group">
          <label for="bot-maxTxCostEth">üí∞ Max TX Cost (ETH, 0 for no limit)</label>
          <input type="number" id="bot-maxTxCostEth" value="0.005" min="0" step="0.0001" />
        </div>

        <div class="input-group">
          <label for="bot-walletsPerCycle">üîÑ Wallets per Cycle (0 for all)</label>
          <input type="number" id="bot-walletsPerCycle" value="0" min="0" />
        </div>

        <div class="input-group">
          <label for="bot-mode">üéØ Action Type</label>
          <select id="bot-mode">
            <option value="random">Random (inc/dec)</option>
            <option value="increment">Force Increment</option>
            <option value="decrement">Force Decrement</option>
          </select>
        </div>

        <div class="input-group">
          <label for="bot-repeat">üîÅ Repeat Mode</label>
          <select id="bot-repeat">
            <option value="no">Run Once</option>
            <option value="yes">Loop Forever</option>
          </select>
        </div>
      </div> <!-- End grid -->

      <button id="bot-startButton" onclick="startFarmingBot()">üöÄ Start Bot</button>
      <button id="bot-stopButton" onclick="stopFarmingBot()" disabled>‚èπÔ∏è Stop Bot</button>
      <button id="bot-downloadGasReport" onclick="downloadGasReportCsv()">‚¨áÔ∏è Download Gas Report (CSV)</button>
    </div>

    <div id="deployer-tab" class="tab-content">
      <h3>Deploy Counter Contract</h3>

      <div class="grid">
        <div class="input-group">
          <label for="deployer-chain">üîó Select Chain</label>
          <select id="deployer-chain" onchange="updateRpcDropdown('deployer')">
            <option value="base">Base Mainnet</option>
            <option value="linea">Linea Mainnet</option>
            <option value="scroll">Scroll Mainnet</option>
            <option value="sepolia">Sepolia Testnet</option>
          </select>
        </div>

        <div class="input-group">
          <label for="deployer-rpc-select">üåê Select RPC URL</label>
          <select id="deployer-rpc-select"></select>
        </div>
        <!-- Hidden input to store the selected RPC URL -->
        <input type="hidden" id="deployer-rpc" />

        <div class="input-group span-2">
          <label for="deployer-pk">üîê Private Key (never leaves browser)</label>
          <input type="password" id="deployer-pk" placeholder="0x...">
        </div>

        <div class="input-group">
          <label for="deployer-maxGasPriceGwei">‚õΩ Max Gas Price (Gwei, 0 for no limit)</label>
          <input type="number" id="deployer-maxGasPriceGwei" value="1" min="0" />
          <span id="deployer-current-gas" class="gas-display">Current: Fetching...</span>
        </div>

        <div class="input-group">
          <label for="deployer-apikey">üß™ Backend Verifier API Key (Optional)</label>
          <input id="deployer-apikey" placeholder="Used by backend for verification">
        </div>
      </div> <!-- End grid -->

      <button id="deployButton" onclick="startDeployer()">üöÄ Deploy Counter Contract</button>
      <button id="verifyButton" onclick="autoVerifyContract()" disabled>‚úÖ Auto Verify Contract</button>
    </div>

    <pre id="log">Logs:\n</pre>
  </div>

  <!-- UPDATED FOOTER SECTION -->
  <footer class="footer">
      <h3>We Grow Together!</h3>
      <p>
          Your contributions help keep this project alive, ad-free, and continuously improving. Consider supporting our development efforts by donating.
      </p>
      <div class="donation-box">
          <span id="donation-address" class="donation-address-text">0x1C46ccEA4D62d3eEC4DCE3501aa96d0Ff5FcA954</span>
          <button id="copy-address-btn" class="footer-icon-button" title="Copy Address">
              <i class="fas fa-clipboard" id="copy-icon"></i>
              <i class="fas fa-check" id="check-icon" style="display: none;"></i>
          </button>
          <button id="show-qr-btn" class="footer-icon-button" title="Show QR Code">
              <i class="fas fa-qrcode"></i>
          </button>
      </div>
      <div class="footer-social-links">
          <a href="https://farm-labs.blogspot.com/" target="_blank" rel="noopener noreferrer" title="Farm Labs Blog">
              <i class="fab fa-blogger"></i>
          </a>
          <a href="https://t.me/farm_lab" target="_blank" rel="noopener noreferrer" title="Farm Lab Telegram">
              <i class="fab fa-telegram"></i>
          </a>
          <a href="https://github.com/CryptoExplor/farmlabs" target="_blank" rel="noopener noreferrer" title="Farm Labs GitHub">
              <i class="fab fa-github"></i>
          </a>
      </div>
      <p class="footer-copyright">
          &copy; 2025 FarmLabs. All rights reserved.
      </p>
  </footer>

  <!-- QR Code Modal -->
  <div id="qr-code-modal" class="modal hidden">
      <div class="modal-content">
          <span class="close-qr-button">&times;</span>
          <h3 style="color: #0f0; margin-bottom: 10px;">Donation Address</h3>
          <div id="qr-code-container"></div>
          <p id="qr-address-display"></p>
      </div>
  </div>

  <script>
    // --- Global Contract Data (will be loaded from counterCompiled.json) ---
    let counterABI = [];
    let counterBytecode = '';
    let counterSourceCode = `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract Counter {
    uint256 private _count;

    function count() public view returns (uint256) {
        return _count;
    }

    function increment() public {
        _count += 1;
    }

    function decrement() public {
        require(_count > 0, "Counter: already at zero");
        _count -= 1;
    }
}`; // Source code for verification
    let counterCompilerVersion = 'v0.8.20+commit.a1b79de6'; // Default, will be updated from JSON
    let counterOptimizationUsed = 0; // Default, will be updated from JSON
    let counterRuns = 200; // Default, will be updated from JSON
    let deployedContractAddress = ''; // To store the address after deployment for verification

    // --- Backend Verifier URL ---
    // IMPORTANT: Replace this with the actual URL of your deployed Cloudflare Worker
    const VERIFIER_BACKEND_URL = 'YOUR_VERIFIER_WORKER_URL_HERE'; // e.g., 'https://your-worker-name.your-username.workers.dev/verify'

    // --- Chain Configurations ---
    const chainConfigs = {
      base: {
        rpcs: [
          "https://mainnet.base.org",
          "https://base.llamarpc.com",
          "https://developer-access-mainnet.base.org",
          "https://1rpc.io/base",
          "https://base.publicnode.com",
          // "https://base-mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID", // Uncomment and replace YOUR_INFURA_PROJECT_ID if you have one
          // "https://base.gateway.tenderly.co" // Uncomment if you have a Tenderly gateway
        ],
        name: "Base Mainnet",
        etherscanApiUrl: "https://api.basescan.org/api", // Etherscan API URL
        browserUrl: "https://basescan.org/address/",
        chainId: 8453,
        etherscanApiKey: "X83R8MW5FKH3VM4DR5DY659VZRSTCGHYI5" // Your provided API key
      },
      linea: {
        rpcs: ["https://rpc.linea.build"],
        name: "Linea Mainnet",
        etherscanApiUrl: "https://api.lineascan.build/api",
        browserUrl: "https://lineascan.build/address/",
        chainId: 59144,
        etherscanApiKey: "X83R8MW5FKH3VM4DR5DY659VZRSTCGHYI5" // Your provided API key
      },
      scroll: {
        rpcs: ["https://rpc.scroll.io"],
        name: "Scroll Mainnet",
        etherscanApiUrl: "https://api.scrollscan.com/api",
        browserUrl: "https://scrollscan.com/address/",
        chainId: 534352,
        etherscanApiKey: "X83R8MW5FKH3VM4DR5DY659VZRSTCGHYI5" // Your provided API key
      },
      sepolia: {
        rpcs: ["https://sepolia.infura.io/v3/YOUR_INFURA_PROJECT_ID"], // REMEMBER TO REPLACE THIS WITH YOUR ACTUAL INFURA PROJECT ID
        name: "Sepolia Testnet",
        etherscanApiUrl: "https://api-sepolia.etherscan.io/api",
        browserUrl: "https://sepolia.etherscan.io/address/",
        chainId: 11155111,
        etherscanApiKey: "X83R8MW5FKH3VM4DR5DY659VZRSTCGHYI5" // Your provided API key
      }
    };

    // --- Global Utility Functions ---
    const log = (msg, type = 'info') => {
      const logEl = document.getElementById("log");
      const span = document.createElement('span');
      span.className = `log-${type}`;
      span.textContent = msg;
      logEl.appendChild(span);
      logEl.textContent += "\n";
      logEl.scrollTop = logEl.scrollHeight;
    };

    const sleep = ms => new Promise(res => setTimeout(res, ms));
    const randomDelay = (min = 5000, max = 15000) => Math.floor(Math.random() * (max - min + 1)) + min;

    // Helper to run a function with retries
    async function runWithRetry(fn, retries = 1, delay = 5000) {
      for (let i = 0; i <= retries; i++) {
        try {
          return await fn();
        } catch (err) {
          log(`‚ö†Ô∏è Attempt ${i + 1} failed: ${err.message}`, 'warning');
          if (i < retries) {
            log(`üîÅ Retrying in ${delay / 1000}s...`, 'info');
            await sleep(delay);
          } else {
            throw new Error(`All ${retries + 1} attempts failed: ${err.message}`);
          }
        }
      }
    }

    // --- Tab Switching Logic ---
    function openTab(tabId) {
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => content.classList.remove('active'));

      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => button.classList.remove('active'));

      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active'); // Set clicked button as active
      document.getElementById("log").textContent = 'Logs:\n'; // Clear log on tab switch

      // If switching to deployer tab, fetch gas price
      if (tabId === 'deployer-tab') {
        fetchAndDisplayDeployerGasPrice();
      }
    }

    // --- RPC Dropdown Update Logic ---
    function updateRpcDropdown(tabPrefix) {
      const chainSelect = document.getElementById(`${tabPrefix}-chain`);
      const rpcSelect = document.getElementById(`${tabPrefix}-rpc-select`);
      const rpcHiddenInput = document.getElementById(`${tabPrefix}-rpc`);

      const selectedChainId = chainSelect.value;
      const rpcsForChain = chainConfigs[selectedChainId].rpcs;

      // Clear existing options
      rpcSelect.innerHTML = '';

      // Add new options
      rpcsForChain.forEach(rpcUrl => {
        const option = document.createElement('option');
        option.value = rpcUrl;
        option.textContent = rpcUrl;
        rpcSelect.appendChild(option);
      });

      // Set the hidden input value to the first RPC by default and trigger change
      if (rpcsForChain.length > 0) {
        rpcSelect.value = rpcsForChain[0];
        rpcHiddenInput.value = rpcsForChain[0];
      } else {
        rpcHiddenInput.value = '';
      }

      // If this is the deployer tab, update gas price display
      if (tabPrefix === 'deployer') {
        fetchAndDisplayDeployerGasPrice();
      }
    }

    // --- Fetch and Display Deployer Gas Price ---
    async function fetchAndDisplayDeployerGasPrice() {
      const rpcUrl = document.getElementById("deployer-rpc-select").value.trim();
      const currentGasDisplay = document.getElementById("deployer-current-gas");

      if (!rpcUrl) {
        currentGasDisplay.textContent = "Current: N/A (No RPC)";
        return;
      }

      currentGasDisplay.textContent = "Current: Fetching...";
      log(`Fetching current gas price from: ${rpcUrl}`, 'info'); // Log the RPC being used
      try {
        const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
        const feeData = await provider.getFeeData();
        const gasPrice = feeData.maxFeePerGas || feeData.gasPrice; // Prefer EIP-1559, fallback to legacy
        if (gasPrice) {
          const gasPriceGwei = ethers.utils.formatUnits(gasPrice, 'gwei');
          currentGasDisplay.textContent = `Current: ${parseFloat(gasPriceGwei).toFixed(3)} Gwei`;
          currentGasDisplay.style.color = '#00ddff'; // Info color
        } else {
          currentGasDisplay.textContent = "Current: N/A (No Gas Price)";
          currentGasDisplay.style.color = '#ffff66'; // Warning color
        }
      } catch (error) {
        currentGasDisplay.textContent = "Current: Error fetching gas";
        currentGasDisplay.style.color = '#ff5555'; // Error color
        console.error("Error fetching deployer gas price:", error);
      }
    }

    /**
     * Determines if a transaction should be skipped based on gas price, estimated cost, and wallet balance.
     * This function is primarily used by the deployer tab for its pre-flight checks.
     * The farming bot now has its own explicit checks within processFarmingWallet.
     * @param {ethers.Wallet} wallet The wallet instance.
     * @param {ethers.providers.Provider} provider The provider connected to the network.
     * @param {ethers.BigNumber} estimatedGasLimit The estimated gas limit for the transaction.
     * @param {number} maxGwei The maximum acceptable gas price in Gwei.
     * @param {number} maxEth The maximum acceptable total transaction cost in ETH.
     * @returns {Promise<boolean>} True if the transaction should be skipped, false otherwise.
     */
    async function shouldSkipTx(wallet, provider, estimatedGasLimit, maxGwei, maxEth) {
      try {
        const feeData = await provider.getFeeData();
        const balance = await wallet.getBalance();

        const gasPrice = feeData.maxFeePerGas || feeData.gasPrice;

        if (!gasPrice) {
            log("‚ö†Ô∏è Could not fetch gas price. Skipping transaction.", 'warning');
            return true;
        }

        const txCost = gasPrice.mul(estimatedGasLimit);

        // Convert to human-readable ETH/gwei
        const gwei = parseFloat(ethers.utils.formatUnits(gasPrice, "gwei"));
        const costEth = parseFloat(ethers.utils.formatEther(txCost));
        const balanceEth = parseFloat(ethers.utils.formatEther(balance));

        if (maxGwei > 0 && gwei > maxGwei) {
          log(`‚ö†Ô∏è Gas too high: ${gwei.toFixed(3)} gwei > ${maxGwei} Gwei limit ‚Äî skipping`, 'warning');
          return true;
        }

        if (maxEth > 0 && costEth > maxEth) {
          log(`‚ö†Ô∏è Tx cost ${costEth.toFixed(6)} ETH > limit ${maxEth} ETH ‚Äî skipping`, 'warning');
          return true;
        }

        // Add a small buffer to the balance check
        const balanceThreshold = ethers.utils.parseEther(maxEth.toString()).add(ethers.utils.parseEther("0.0001")); // Buffer for potential slight variations
        if (balance.lt(txCost.add(ethers.utils.parseEther("0.0001")))) { // Check if balance is less than txCost + small buffer
          log(`‚ö†Ô∏è Wallet low on funds (${balanceEth.toFixed(6)} ETH) for estimated cost ${costEth.toFixed(6)} ETH ‚Äî skipping`, 'warning');
          return true;
        }

        return false;
      } catch (error) {
        log(`‚ùå Error in gas guard check: ${error.message}. Skipping transaction to be safe.`, 'error');
        return true; // Skip on error to prevent unexpected behavior
      }
    }


    // --- Counter Bot Logic ---
    let isFarmingBotRunning = false;
    let farmingBotStopFlag = false;
    let gasReportEntries = []; // Stores data for CSV export

    function updateFarmingBotButtonStates(running) {
      document.getElementById("bot-startButton").disabled = running;
      document.getElementById("bot-stopButton").disabled = !running;
      document.getElementById("bot-rpc-select").disabled = running; // Disable RPC select
      document.getElementById("bot-contract").disabled = running;
      document.getElementById("bot-keys").disabled = running;
      document.getElementById("bot-maxRetries").disabled = running;
      document.getElementById("bot-retryDelay").disabled = running;
      document.getElementById("bot-maxGasPriceGwei").disabled = running;
      document.getElementById("bot-maxTxCostEth").disabled = running; // Disable max tx cost
      document.getElementById("bot-walletsPerCycle").disabled = running;
      document.getElementById("bot-mode").disabled = running;
      document.getElementById("bot-repeat").disabled = running;
      document.getElementById("bot-chain").disabled = running; // Disable chain select
      document.getElementById("bot-downloadGasReport").disabled = running || gasReportEntries.length === 0;
    }

    function stopFarmingBot() {
      farmingBotStopFlag = true;
      log("üõë Stop command received. Finishing current wallet and then stopping farming bot...", 'info');
    }

    async function processFarmingWallet(wallet, contract, action, index, maxRetries, retryDelayMs, maxGasPriceGwei, maxTxCostEth, chainInfo) {
      const address = wallet.address;
      const walletLabel = wallet.label ? ` (${wallet.label})` : '';
      let gasUsed = ethers.BigNumber.from(0);
      let actionStatus = 'Failed'; // Default status for gas report
      let txHash = 'N/A';

      try { // Start of the new try block for checks
        const feeData = await wallet.provider.getFeeData();
        const gasPrice = feeData.maxFeePerGas || feeData.gasPrice;
        const balance = await wallet.getBalance();

        if (!gasPrice) {
            log("‚ö†Ô∏è Could not fetch gas price. Skipping transaction.", 'warning');
            actionStatus = 'Skipped (No Gas Price)';
            return gasUsed;
        }

        // Estimate gas limit for the specific action
        const estimatedGasLimit = await runWithRetry(() => contract.estimateGas[action](), maxRetries, retryDelayMs);
        const estimatedCost = gasPrice.mul(estimatedGasLimit);

        // Convert to human-readable for logging and comparison
        const gwei = parseFloat(ethers.utils.formatUnits(gasPrice, "gwei"));
        const costEth = parseFloat(ethers.utils.formatEther(estimatedCost));
        const balanceEth = parseFloat(ethers.utils.formatEther(balance));

        // Skip if gas price is too high
        if (maxGasPriceGwei > 0 && gwei > maxGasPriceGwei) {
          log(`‚õΩ Gas too high: ${gwei.toFixed(3)} gwei > ${maxGasPriceGwei} Gwei limit ‚Äî Skipping Wallet ${index + 1}${walletLabel}`, 'warning');
          actionStatus = 'Skipped (Gas Too High)';
          return gasUsed;
        }

        // Skip if estimated transaction cost exceeds user's max ETH limit
        if (maxTxCostEth > 0 && costEth > maxTxCostEth) {
          log(`‚ö†Ô∏è Tx cost ${costEth.toFixed(6)} ETH > limit ${maxTxCostEth} ETH ‚Äî Skipping Wallet ${index + 1}${walletLabel}`, 'warning');
          actionStatus = 'Skipped (Tx Cost Too High)';
          return gasUsed;
        }

        // Skip if wallet has insufficient funds
        // Add a small buffer to the balance check to account for network fluctuations or minor gas changes
        if (balance.lt(estimatedCost.add(ethers.utils.parseEther("0.0001")))) {
          log(`üí∏ Wallet ${index + 1}${walletLabel} has insufficient funds (${balanceEth.toFixed(6)} ETH, needs approx. ${costEth.toFixed(6)} ETH) ‚Äî Skipping`, 'warning');
          actionStatus = 'Skipped (Low Balance)';
          return gasUsed;
        }

        log(`‚õΩ Estimated cost: ${costEth.toFixed(6)} ETH | Wallet balance: ${balanceEth.toFixed(6)} ETH`, 'info');
        log(`‚õΩ Gas estimate for ${action}: ${estimatedGasLimit.toString()} units`);

        if (Math.random() < 0.1) { // 10% chance for dummy read
            await runWithRetry(() => contract.count(), maxRetries, retryDelayMs);
            log(`üëÄ Performed dummy view call: count()`);
        }

        const tx = await runWithRetry(() => contract[action](), maxRetries, retryDelayMs);
        txHash = tx.hash; // Store tx hash immediately
        log(`üöÄ TX Sent (${action}): ${txHash}`);

        const receipt = await runWithRetry(() => tx.wait(), maxRetries, retryDelayMs);
        gasUsed = receipt.gasUsed;
        actionStatus = 'Success';

        const countAfter = await runWithRetry(() => contract.count(), maxRetries, retryDelayMs);
        log(`‚úÖ Confirmed. Updated Count: ${countAfter.toString()} | Gas Used for this TX: ${gasUsed.toString()} units`, 'success');

      } catch (err) {
        log(`‚ùå Wallet ${index + 1}${walletLabel} (${address.slice(0, 6)}...${address.slice(-4)}) error: ${err.message}`, 'error');
        actionStatus = 'Failed';
      } finally {
        // Record for gas report
        gasReportEntries.push({
          Timestamp: new Date().toISOString(),
          WalletAddress: address,
          WalletLabel: wallet.label || '',
          Action: action,
          GasUsed: gasUsed.toString(),
          Status: actionStatus,
          ChainName: chainInfo.name,
          ChainId: chainInfo.chainId,
          TxHash: txHash
        });
      }

      return gasUsed;
    }

    async function startFarmingBot() {
      if (isFarmingBotRunning) {
        log("Farming bot is already running. Please stop it first.", 'warning');
        return;
      }

      const selectedChainId = document.getElementById("bot-chain").value;
      const chainInfo = chainConfigs[selectedChainId];
      if (!chainInfo) {
        return log("‚ùå Invalid chain selected.", 'error');
      }

      // Get RPC URL from the dropdown
      const rpc = document.getElementById("bot-rpc-select").value.trim();
      
      const contractAddress = document.getElementById("bot-contract").value.trim();
      const keysInput = document.getElementById("bot-keys").value.trim().split("\n").filter(k => k);
      const maxRetries = parseInt(document.getElementById("bot-maxRetries").value) || 1;
      const retryDelayMs = parseInt(document.getElementById("bot-retryDelay").value) || 5000;
      const maxGasPriceGwei = parseFloat(document.getElementById("bot-maxGasPriceGwei").value) || 0;
      const maxTxCostEth = parseFloat(document.getElementById("bot-maxTxCostEth").value) || 0; // Get max tx cost
      const walletsPerCycle = parseInt(document.getElementById("bot-walletsPerCycle").value) || 0;
      const actionMode = document.getElementById("bot-mode").value;
      const repeatMode = document.getElementById("bot-repeat").value === "yes";

      document.getElementById("log").textContent = 'Logs:\n'; // Clear logs for new session
      gasReportEntries = []; // Reset gas report for new session

      if (!rpc || !ethers.utils.isAddress(contractAddress) || keysInput.length === 0) {
        return log("‚ùå Please ensure RPC URL, a valid Contract Address, and Private Keys are provided for the bot.", 'error');
      }

      isFarmingBotRunning = true;
      farmingBotStopFlag = false;
      updateFarmingBotButtonStates(true);

      log("üöÄ Starting farming bot interaction...", 'info');
      log(`Chain: ${chainInfo.name} | RPC: ${rpc}`, 'info');
      log(`Configured with ${keysInput.length} wallet entries, Max Retries: ${maxRetries}, Retry Delay: ${retryDelayMs / 1000}s`);
      log(`Max Gas Price: ${maxGasPriceGwei} Gwei | Max TX Cost: ${maxTxCostEth} ETH | Wallets per Cycle: ${walletsPerCycle === 0 ? 'All' : walletsPerCycle}`);
      log(`Action Type: ${actionMode.charAt(0).toUpperCase() + actionMode.slice(1)} | Repeat Mode: ${repeatMode ? 'Loop Forever' : 'Run Once'}`, 'info');

      const provider = new ethers.providers.JsonRpcProvider(rpc);
      const wallets = [];
      for (const entry of keysInput) {
        const parts = entry.split('#');
        const pk = parts[0].trim();
        const label = parts[1] ? parts[1].trim() : null;
        try {
          const wallet = new ethers.Wallet(pk, provider);
          wallets.push({ wallet, label });
        } catch (e) {
          log(`‚ùå Invalid private key encountered: ${pk.slice(0, 10)}... Skipping this key.`, 'error');
        }
      }

      if (wallets.length === 0) {
        log("‚ùå No valid wallets loaded for farming. Please check your private keys.", 'error');
        isFarmingBotRunning = false;
        updateFarmingBotButtonStates(false);
        return;
      }

      do {
        let totalGasForCycle = ethers.BigNumber.from(0);
        const walletsToProcess = walletsPerCycle === 0 ? wallets : wallets.slice(0, walletsPerCycle); // Select N wallets or all

        log(`\n--- Starting new cycle (${walletsToProcess.length} wallets to process) ---`, 'info');

        for (let i = 0; i < walletsToProcess.length; i++) {
          if (farmingBotStopFlag) break;

          const { wallet, label } = walletsToProcess[i];
          const contract = new ethers.Contract(contractAddress, counterABI, wallet);
          
          let action;
          if (actionMode === "random") {
            action = Math.random() > 0.5 ? "increment" : "decrement";
          } else {
            action = actionMode;
          }

          const gasUsedByWallet = await processFarmingWallet(wallet, contract, action, i, maxRetries, retryDelayMs, maxGasPriceGwei, maxTxCostEth, chainInfo);
          totalGasForCycle = totalGasForCycle.add(gasUsedByWallet);

          if (farmingBotStopFlag) break;

          const delay = randomDelay();
          log(`‚è±Ô∏è Waiting ${delay / 1000}s before next wallet...`, 'info');
          await sleep(delay);
        }

        log(`üìä Cycle Complete. Total Gas Used for this cycle: ${totalGasForCycle.toString()} units\n`, 'info');

      } while (repeatMode && !farmingBotStopFlag);

      isFarmingBotRunning = false;
      farmingBotStopFlag = false;
      updateFarmingBotButtonStates(false);
      log("\nüéâ All farming operations completed. Bot finished.", 'success');
      document.getElementById("bot-downloadGasReport").disabled = gasReportEntries.length === 0; // Enable download button if there are entries
    }

    // --- Gas Report Download ---
    function downloadGasReportCsv() {
      if (gasReportEntries.length === 0) {
        log("No gas report data to download.", 'warning');
        return;
      }

      const headers = Object.keys(gasReportEntries[0]).join(',');
      const rows = gasReportEntries.map(entry =>
        Object.values(entry).map(value => `"${String(value).replace(/"/g, '""')}"`).join(',')
      );

      const csvContent = headers + '\n' + rows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `farmlabs_gas_report_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      log('Gas report downloaded as CSV.', 'info');
    }


    // --- Contract Deployer Logic ---
    let isDeploying = false;

    function updateDeployerButtonStates(deploying) {
        document.getElementById("deployButton").disabled = deploying;
        document.getElementById("verifyButton").disabled = deploying || !deployedContractAddress; // Enable verify only after deployment
        document.getElementById("deployer-pk").disabled = deploying;
        document.getElementById("deployer-rpc-select").disabled = deploying; // Disable RPC select
        document.getElementById("deployer-apikey").disabled = deploying;
        document.getElementById("deployer-chain").disabled = deploying; // Disable chain select
        document.getElementById("deployer-maxGasPriceGwei").disabled = deploying; // Disable gas price input
    }

    async function startDeployer() {
      if (isDeploying) {
        log("Deployment already in progress. Please wait...", 'warning');
        return;
      }

      const selectedChainId = document.getElementById("deployer-chain").value;
      const chainInfo = chainConfigs[selectedChainId];
      if (!chainInfo) {
        return log("‚ùå Invalid chain selected for deployer.", 'error');
      }

      let privateKey = document.getElementById("deployer-pk").value.trim();
      // Get RPC URL from the dropdown
      const rpcUrl = document.getElementById("deployer-rpc-select").value.trim();
      // API key is now part of chainInfo, but we keep the input for user to override if needed
      const apiKey = document.getElementById("deployer-apikey").value.trim() || chainInfo.etherscanApiKey;
      const maxGasPriceGwei = parseFloat(document.getElementById("deployer-maxGasPriceGwei").value) || 0;


      document.getElementById("log").textContent = 'Logs:\n'; // Clear logs for new session

      if (!privateKey || !rpcUrl) {
        return log("‚ùå Please fill in Private Key and RPC URL for deployment.", 'error');
      }
      
      if (!privateKey.startsWith('0x') && privateKey.length === 64) {
        log("Adding '0x' prefix to private key.", 'info');
        privateKey = '0x' + privateKey;
      } else if (!privateKey.startsWith('0x')) {
        return log("‚ùå Private Key must start with '0x' or be 64 characters long.", 'error');
      }
      
      if (privateKey.length !== 66) {
          return log("‚ùå Private Key must be 66 characters long (including '0x').", 'error');
      }

      isDeploying = true;
      updateDeployerButtonStates(true);
      log("üöÄ Initiating contract deployment...", 'info');
      log(`Chain: ${chainInfo.name} | RPC: ${rpcUrl}`, 'info');

      try {
        const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
        const wallet = new ethers.Wallet(privateKey, provider);

        // Estimate gas limit for deployment
        const factory = new ethers.ContractFactory(counterABI, counterBytecode, wallet);
        const estimatedGasLimit = await runWithRetry(() => factory.estimateGas.deploy(), 1, 5000); // Deploy is a special case for estimateGas
        log(`‚õΩ Estimated gas for deployment: ${estimatedGasLimit.toString()} units`);

        // Use the smart gas guard before proceeding with deployment
        // For deployment, we don't have a specific maxEth input, but we can use a high default or derive it
        // For simplicity, we'll just check maxGwei for deployment here.
        // A more advanced version might have a separate maxEth for deployment.
        const skip = await shouldSkipTx(wallet, provider, estimatedGasLimit, maxGasPriceGwei, 999999); // High maxEth for deployment check
        if (skip) {
            isDeploying = false;
            updateDeployerButtonStates(false);
            return;
        }

        log(`Connected to RPC: ${rpcUrl}`, 'info');
        log(`Deployer address: ${wallet.address}`, 'info');

        const balance = await wallet.getBalance();
        log(`Wallet balance: ${ethers.utils.formatEther(balance)} ETH`, 'info');
        if (balance.isZero()) {
          log("‚ùå Wallet has 0 ETH. Please fund your wallet before deploying.", 'error');
          return;
        }

        log("üì¶ Sending deployment transaction...", 'info');
        const contract = await factory.deploy();
        log(`‚û°Ô∏è Deployment TX Hash: ${contract.deployTransaction.hash}`, 'info');

        log("‚è≥ Waiting for transaction to be mined...", 'info');
        await contract.deployed();
        deployedContractAddress = contract.address; // Store deployed address
        log(`‚úÖ Contract deployed at: ${deployedContractAddress}`, 'success');

        updateDeployerButtonStates(false); // Re-enable buttons after deployment, including verify

        log(`\n--- Manual Verification Steps ---`, 'info');
        log(`To verify your contract on ${chainInfo.name}'s Explorer, visit:`, 'info');
        log(`${chainInfo.browserUrl}${deployedContractAddress}#code`, 'info');
        log(`\nIf you wish to auto-verify, click the 'Auto Verify Contract' button.`, 'info');


      } catch (err) {
        log(`‚ùå Deployment failed: ${err.message}`, 'error');
        console.error(err);
      } finally {
        isDeploying = false;
        updateDeployerButtonStates(false);
        document.getElementById("deployer-pk").value = ''; // Clear private key input for security
      }
    }

    async function autoVerifyContract() {
        if (!deployedContractAddress) {
            log("‚ùå No contract address found. Please deploy a contract first.", 'error');
            return;
        }

        const selectedChainId = document.getElementById("deployer-chain").value;
        const chainInfo = chainConfigs[selectedChainId];
        if (!chainInfo) {
            log("‚ùå Invalid chain selected for verification.", 'error');
            return;
        }

        const etherscanApiKey = document.getElementById("deployer-apikey").value.trim() || chainInfo.etherscanApiKey;

        if (!etherscanApiKey && VERIFIER_BACKEND_URL === 'YOUR_VERIFIER_WORKER_URL_HERE') {
            log("‚ùå Please provide an Etherscan API Key or configure the backend verifier URL.", 'error');
            return;
        }

        log("‚è≥ Attempting automatic verification via backend...", 'info');

        try {
            const response = await fetch(VERIFIER_BACKEND_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contractAddress: deployedContractAddress,
                    sourceCode: counterSourceCode,
                    contractName: 'Counter',
                    compilerVersion: counterCompilerVersion,
                    optimizationUsed: counterOptimizationUsed,
                    runs: counterRuns,
                    chainId: chainInfo.chainId,
                    etherscanApiKey: etherscanApiKey // Pass API key to backend
                }),
            });

            const result = await response.json();

            if (response.ok && result.status === '1') {
                log(`‚úÖ Verification successful! Check: ${chainInfo.browserUrl}${deployedContractAddress}`, 'success');
                log(`Verification GUID: ${result.result}`, 'info');
            } else {
                log(`‚ùå Verification failed: ${result.message || JSON.stringify(result)}`, 'error');
            }
        } catch (error) {
            log(`‚ùå Error during verification request: ${error.message}`, 'error');
            console.error("Verification error:", error);
        }
    }


    // --- Initial Setup and Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Load compiled contract data
        try {
            const response = await fetch('counterCompiled.json');
            if (!response.ok) {
                throw new Error(`Failed to load counterCompiled.json: ${response.statusText}`);
            }
            const compiledData = await response.json();
            counterABI = compiledData.abi;
            counterBytecode = compiledData.bytecode;
            counterCompilerVersion = compiledData.compilerVersion;
            counterOptimizationUsed = compiledData.optimizationUsed;
            counterRuns = compiledData.runs;
            log("‚úÖ Contract ABI and Bytecode loaded from counterCompiled.json", 'success');
        } catch (error) {
            log(`‚ùå Error loading contract data: ${error.message}. Using hardcoded defaults.`, 'error');
            // Fallback to hardcoded if loading fails
        }


        // Initialize RPC dropdowns and hidden inputs
        updateRpcDropdown('bot');
        updateRpcDropdown('deployer');

        // Add event listeners for chain selection to update RPC dropdown
        document.getElementById('bot-chain').addEventListener('change', () => updateRpcDropdown('bot'));
        document.getElementById('deployer-chain').addEventListener('change', () => updateRpcDropdown('deployer'));

        // Add event listeners for RPC dropdowns to update hidden RPC input
        document.getElementById('bot-rpc-select').addEventListener('change', (event) => {
            document.getElementById('bot-rpc').value = event.target.value;
            log(`Bot RPC set to: ${event.target.value}`, 'info');
        });
        document.getElementById('deployer-rpc-select').addEventListener('change', (event) => {
            document.getElementById('deployer-rpc').value = event.target.value;
            log(`Deployer RPC set to: ${event.target.value}`, 'info');
            fetchAndDisplayDeployerGasPrice(); // Fetch gas price when RPC changes
        });

        // Initial fetch of deployer gas price if deployer tab is active
        if (document.getElementById('deployer-tab').classList.contains('active')) {
            fetchAndDisplayDeployerGasPrice();
        }

        // --- Footer Logic (Copied and adapted from advance.html) ---
        const donationAddressStr = '0x1C46ccEA4D62d3eEC4DCE3501aa96d0Ff5FcA954';
        const copyBtn = document.getElementById('copy-address-btn');
        const copyIcon = document.getElementById('copy-icon');
        const checkIcon = document.getElementById('check-icon');
        const showQrBtn = document.getElementById('show-qr-btn');
        const qrModal = document.getElementById('qr-code-modal');
        const closeQrModalBtn = qrModal.querySelector('.close-qr-button');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const qrAddressDisplay = document.getElementById('qr-address-display');

        // Ensure checkIcon is hidden initially
        checkIcon.style.display = 'none';

        // Function to copy text to clipboard (using execCommand for broader iframe compatibility)
        const copyToClipboard = (text) => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                log(`Copied "${text}" to clipboard.`, 'info');
            } catch (err) {
                log('Failed to copy to clipboard (unsupported by browser/iframe).', 'error');
            }
            document.body.removeChild(textarea);
        };

        // Initialize QR Code
        if(typeof QRCode !== 'undefined') {
            new QRCode(qrCodeContainer, {
                text: donationAddressStr,
                width: 150, /* Slightly smaller for compact modal */
                height: 150,
                colorDark : "#000000", /* Black QR code */
                colorLight : "#ffffff", /* White background */
                correctLevel : QRCode.CorrectLevel.H
            });
            qrAddressDisplay.textContent = donationAddressStr;
        } else {
            console.error("QRCode library is not loaded.")
            qrCodeContainer.innerHTML = "QR Code library failed to load. Please check your connection.";
        }

        // Footer Event Listeners
        copyBtn.addEventListener('click', () => {
            copyToClipboard(donationAddressStr);
            copyIcon.style.display = 'none';
            checkIcon.style.display = 'inline-block';
            setTimeout(() => {
                copyIcon.style.display = 'inline-block';
                checkIcon.style.display = 'none';
            }, 2000);
        });

        showQrBtn.addEventListener('click', () => {
            qrModal.classList.remove('hidden');
        });

        const closeQrModal = () => {
            qrModal.classList.add('hidden');
        }
        closeQrModalBtn.addEventListener('click', closeQrModal);
        // The window click listener is for clicks *outside* the modal content
        window.addEventListener('click', (event) => {
            // Ensure the click is on the modal background itself, not its content
            if (event.target === qrModal) {
                closeQrModal();
            }
        });
    });
  </script>

</body>
</html>
